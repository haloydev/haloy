name: Update Homebrew Tap

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  update-tap:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Set version variables
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION_NO_V="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NO_V=$VERSION_NO_V" >> $GITHUB_ENV
          echo "Updating to version: $VERSION ($VERSION_NO_V)"

      - name: Download release assets
        run: |
          mkdir -p dist
          cd dist

          # Download the checksums file
          curl -L -o checksums.txt \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/checksums.txt"

          cat checksums.txt

      - name: Extract checksums
        id: checksums
        run: |
          ARM64_SHA=$(grep "haloy-darwin-arm64$" dist/checksums.txt | awk '{print $1}')
          AMD64_SHA=$(grep "haloy-darwin-amd64$" dist/checksums.txt | awk '{print $1}')

          if [[ -z "$ARM64_SHA" || -z "$AMD64_SHA" ]]; then
            echo "Error: Could not extract checksums"
            exit 1
          fi

          echo "ARM64_SHA=$ARM64_SHA" >> $GITHUB_ENV
          echo "AMD64_SHA=$AMD64_SHA" >> $GITHUB_ENV
          echo "Found ARM64 SHA: $ARM64_SHA"
          echo "Found AMD64 SHA: $AMD64_SHA"

      - name: Checkout main repo for template
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: haloydev/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula from template
        run: |
          sed -e "s/{{VERSION}}/${{ env.VERSION_NO_V }}/g" \
              -e "s/{{VERSION_TAG}}/${{ env.VERSION }}/g" \
              -e "s/{{ARM64_SHA}}/${{ env.ARM64_SHA }}/g" \
              -e "s/{{AMD64_SHA}}/${{ env.AMD64_SHA }}/g" \
              main-repo/.github/homebrew-formula.rb.template > homebrew-tap/haloy.rb

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet haloy.rb; then
            echo "No changes to commit"
            exit 0
          fi

          git add haloy.rb
          git commit -m "Update haloy to ${{ env.VERSION }}"
          git push

